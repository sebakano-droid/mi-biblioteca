<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bibliotecask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <style>
        .gradient-bg { background: #1a1a1a; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ‚ö†Ô∏è IMPORTANTE: Reemplaz√° estos valores con los de tu proyecto Firebase
        // Instrucciones en COMO-CONFIGURAR-FIREBASE.md
        const firebaseConfig = {
            apiKey: "AIzaSyBalAvuymc2HV5b3vyiAl5ZJj2b_8ZUGCg",
            authDomain: "bibliotecask-ee7f8.firebaseapp.com",
            projectId: "bibliotecask-ee7f8",
            storageBucket: "bibliotecask-ee7f8.firebasestorage.app",
            messagingSenderId: "231963751299",
            appId: "1:231963751299:web:9768d54cb569c365ba7cb6"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        // ============ CONTEXTO DE AUTENTICACI√ìN ============
        const AuthContext = createContext();

        function AuthProvider({ children }) {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        // Cargar perfil del usuario
                        const doc = await db.collection('users').doc(firebaseUser.uid).get();
                        if (doc.exists) {
                            setUserProfile(doc.data());
                        }
                    } else {
                        setUser(null);
                        setUserProfile(null);
                    }
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            const signUp = async (email, password, name) => {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                // Crear perfil del usuario
                await db.collection('users').doc(result.user.uid).set({
                    name,
                    email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    friends: [],
                    friendRequests: []
                });
                // Crear colecci√≥n de libros vac√≠a
                await db.collection('users').doc(result.user.uid).collection('books').doc('_init').set({ init: true });
                return result;
            };

            const signIn = (email, password) => auth.signInWithEmailAndPassword(email, password);
            const signOut = () => auth.signOut();

            return (
                <AuthContext.Provider value={{ user, userProfile, loading, signUp, signIn, signOut, setUserProfile }}>
                    {children}
                </AuthContext.Provider>
            );
        }

        const useAuth = () => useContext(AuthContext);

        // ============ CONSTANTES ============
        const RATING_CRITERIA = [
            { key: 'impacto', label: 'Impacto personal', desc: '¬øCu√°nto te cambi√≥?' },
            { key: 'escritura', label: 'Calidad de escritura', desc: '¬øQu√© tan bien escrito?' },
            { key: 'enganche', label: 'Enganche', desc: '¬øPudiste soltarlo?' },
            { key: 'valorLargoPlazo', label: 'Valor a largo plazo', desc: '¬øLo releer√≠as?' },
            { key: 'recomendabilidad', label: 'Recomendabilidad', desc: '¬øLo recomendar√≠as?' },
        ];

        // ============ ICONOS SVG ============
        const Icons = {
            Book: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
            Star: ({ filled }) => <svg className={`w-4 h-4 ${filled ? 'fill-amber-400 text-amber-400' : 'text-gray-300'}`} fill={filled ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Heart: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>,
            Camera: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Upload: () => <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            Sparkles: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            Share: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>,
            Link: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>,
            WhatsApp: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Mail: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            ChevronRight: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
            Video: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
        };

        // ============ PANTALLA DE LOGIN ============
        function AuthScreen() {
            const { signIn, signUp } = useAuth();
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    if (isLogin) {
                        await signIn(email, password);
                    } else {
                        if (!name.trim()) {
                            setError('Por favor ingres√° tu nombre');
                            setLoading(false);
                            return;
                        }
                        await signUp(email, password, name);
                    }
                } catch (err) {
                    console.error(err);
                    if (err.code === 'auth/email-already-in-use') {
                        setError('Este email ya est√° registrado');
                    } else if (err.code === 'auth/weak-password') {
                        setError('La contrase√±a debe tener al menos 6 caracteres');
                    } else if (err.code === 'auth/invalid-email') {
                        setError('Email inv√°lido');
                    } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setError('Email o contrase√±a incorrectos');
                    } else {
                        setError('Error: ' + err.message);
                    }
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-6">
                            <span className="text-6xl">üìö</span>
                            <h1 className="text-2xl font-bold mt-4">bibliotecask</h1>
                            <p className="text-gray-500 mt-1">
                                {isLogin ? 'Inici√° sesi√≥n para continuar' : 'Cre√° tu cuenta gratis'}
                            </p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 focus:border-gray-500"
                                        placeholder="Tu nombre"
                                    />
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 focus:border-gray-500"
                                    placeholder="tu@email.com"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 focus:border-gray-500"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    required
                                    minLength={6}
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 text-red-700 p-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-gray-800 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {loading ? (
                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                ) : (
                                    isLogin ? 'Iniciar sesi√≥n' : 'Crear cuenta'
                                )}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button
                                onClick={() => { setIsLogin(!isLogin); setError(''); }}
                                className="text-gray-700 hover:text-gray-800 text-sm"
                            >
                                {isLogin ? '¬øNo ten√©s cuenta? Crear una' : '¬øYa ten√©s cuenta? Iniciar sesi√≥n'}
                            </button>
                        </div>

                        <div className="mt-6 bg-gradient-to-r from-gray-50 to-gray-50 rounded-xl p-4 border border-gray-200">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">üì∑</span>
                                <div>
                                    <p className="font-medium text-gray-900 text-sm">Escane√° tu estanter√≠a</p>
                                    <p className="text-xs text-gray-600">Sacale una foto a tus libros y los detectamos autom√°ticamente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ COMPONENTES ============
        function StarRating({ value, onChange, readonly = false }) {
            return (
                <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button
                            key={star}
                            onClick={() => !readonly && onChange && onChange(star)}
                            className={!readonly ? 'cursor-pointer hover:scale-110 transition-transform' : ''}
                            disabled={readonly}
                        >
                            <Icons.Star filled={star <= value} />
                        </button>
                    ))}
                </div>
            );
        }

        function calculateAverage(ratings) {
            if (!ratings) return null;
            const values = Object.values(ratings);
            return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
        }

        function BookCard({ book, onToggleRead, onRate, onRecommend, onDelete }) {
            const [showRating, setShowRating] = useState(false);
            const [tempRatings, setTempRatings] = useState(book.ratings || {});
            const avg = calculateAverage(book.ratings);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow">
                    <div className="flex gap-4">
                        {book.cover && book.cover.startsWith('http') ? (
                            <img src={book.cover} alt={book.title} className="w-16 h-20 object-cover rounded-lg shadow-sm" />
                        ) : (
                            <div className="text-5xl">{book.cover || 'üìö'}</div>
                        )}
                        <div className="flex-1 min-w-0">
                            <div className="flex items-start justify-between">
                                <div>
                                    <h3 className="font-semibold text-gray-900 truncate">{book.title}</h3>
                                    <p className="text-sm text-gray-500">{book.author}</p>
                                </div>
                                {onDelete && (
                                    <button onClick={() => onDelete(book.id)} className="text-gray-300 hover:text-red-500 p-1">
                                        <Icons.X />
                                    </button>
                                )}
                            </div>
                            <div className="flex items-center gap-3 mt-2">
                                <button
                                    onClick={() => onToggleRead(book.id)}
                                    className={`flex items-center gap-1.5 text-xs px-2 py-1 rounded-full transition-colors ${
                                        book.read ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                    }`}
                                >
                                    {book.read ? <Icons.Check /> : <Icons.Book />}
                                    {book.read ? 'Le√≠do' : 'Por leer'}
                                </button>
                                {avg && (
                                    <div className="flex items-center gap-1 text-sm">
                                        <Icons.Star filled={true} />
                                        <span className="font-medium">{avg}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {book.read && (
                        <div className="mt-3 pt-3 border-t border-gray-100">
                            {!showRating ? (
                                <div className="flex gap-2">
                                    <button onClick={() => setShowRating(true)} className="flex-1 text-sm text-gray-700 hover:text-indigo-700 font-medium">
                                        {book.ratings ? 'Editar valoraci√≥n' : 'Valorar'}
                                    </button>
                                    <button onClick={() => onRecommend(book)} className="flex items-center gap-1 text-sm text-pink-600 hover:text-pink-700">
                                        <Icons.Heart /> Recomendar
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {RATING_CRITERIA.map(({ key, label, desc }) => (
                                        <div key={key} className="flex items-center justify-between gap-2">
                                            <div className="min-w-0">
                                                <p className="text-sm font-medium text-gray-700 truncate">{label}</p>
                                                <p className="text-xs text-gray-400 truncate">{desc}</p>
                                            </div>
                                            <StarRating value={tempRatings[key] || 0} onChange={(v) => setTempRatings({ ...tempRatings, [key]: v })} />
                                        </div>
                                    ))}
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { onRate(book.id, tempRatings); setShowRating(false); }} className="flex-1 bg-gray-900 text-white text-sm py-1.5 rounded-lg hover:bg-gray-800">
                                            Guardar
                                        </button>
                                        <button onClick={() => setShowRating(false)} className="px-3 text-gray-500 hover:text-gray-700">
                                            <Icons.X />
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function FriendRecommendation({ rec, onAddToList, onAddToWishlist }) {
            return (
                <div className="bg-gradient-to-br from-pink-50 to-purple-50 rounded-xl p-4 border border-pink-100">
                    <div className="flex items-start gap-3">
                        <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-lg">
                            {rec.fromName?.charAt(0)?.toUpperCase() || '?'}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                                <span className="font-medium text-gray-900">{rec.fromName}</span>
                                <span className="text-gray-400">te recomienda</span>
                            </div>
                            <h4 className="font-semibold text-gray-900 mt-1">{rec.bookTitle}</h4>
                            <p className="text-sm text-gray-500">{rec.bookAuthor}</p>

                            {rec.basedOn && (
                                <div className="flex items-center gap-1.5 mt-2 bg-white/60 rounded-full px-2.5 py-1 w-fit">
                                    <Icons.Link />
                                    <span className="text-xs text-gray-600">Porque te gust√≥ <strong>{rec.basedOn}</strong></span>
                                </div>
                            )}

                            {rec.comment && (
                                <p className="text-sm text-gray-600 mt-2 italic">"{rec.comment}"</p>
                            )}
                        </div>
                    </div>

                    <div className="flex gap-2 mt-3">
                        <button onClick={() => onAddToList(rec)} className="flex-1 bg-gray-900 text-white text-sm py-2 rounded-lg hover:bg-gray-800 flex items-center justify-center gap-1">
                            üìö Ya lo tengo
                        </button>
                        <button onClick={() => onAddToWishlist(rec)} className="flex-1 bg-amber-500 text-white text-sm py-2 rounded-lg hover:bg-amber-600 flex items-center justify-center gap-1">
                            üõí Por comprar
                        </button>
                    </div>
                </div>
            );
        }

        function AddBookModal({ onClose, onAdd }) {
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const covers = ['üìó', 'üìò', 'üìô', 'üìï', 'üìî', 'üìì'];
            const [cover, setCover] = useState(covers[0]);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Agregar libro</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" placeholder="Ej: Don Quijote" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Autor</label>
                                <input type="text" value={author} onChange={(e) => setAuthor(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500" placeholder="Ej: Miguel de Cervantes" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Portada</label>
                                <div className="flex gap-2">
                                    {covers.map((c) => (
                                        <button key={c} onClick={() => setCover(c)} className={`text-3xl p-2 rounded-lg transition-colors ${cover === c ? 'bg-gray-100 ring-2 ring-indigo-500' : 'hover:bg-gray-100'}`}>
                                            {c}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <button onClick={() => { if (title && author) { onAdd({ title, author, cover }); onClose(); }}} disabled={!title || !author} className="w-full mt-6 bg-gray-900 text-white py-2.5 rounded-lg font-medium hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                            Agregar a bibliotecask
                        </button>
                    </div>
                </div>
            );
        }

        function RecommendModal({ book, friends, myBooks, onClose, onSend }) {
            const { user, userProfile } = useAuth();
            const [selectedFriends, setSelectedFriends] = useState([]);
            const [comment, setComment] = useState('');
            const [basedOnBook, setBasedOnBook] = useState('');
            const [sending, setSending] = useState(false);

            const readBooks = myBooks.filter(b => b.read && b.id !== book.id);

            const toggleFriend = (id) => {
                setSelectedFriends(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
            };

            const handleSend = async () => {
                if (selectedFriends.length === 0) return;
                setSending(true);

                try {
                    // Enviar recomendaci√≥n a cada amigo seleccionado
                    for (const friendId of selectedFriends) {
                        await db.collection('users').doc(friendId).collection('recommendations').add({
                            bookTitle: book.title,
                            bookAuthor: book.author,
                            bookCover: book.cover,
                            fromUserId: user.uid,
                            fromName: userProfile?.name || 'Alguien',
                            basedOn: basedOnBook || null,
                            comment: comment || null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    onSend();
                } catch (error) {
                    console.error('Error sending recommendation:', error);
                    alert('Error al enviar la recomendaci√≥n');
                }
                setSending(false);
            };

            // Generar link de WhatsApp para compartir
            const shareViaWhatsApp = () => {
                const appUrl = window.location.origin;
                const message = `üìö ¬°Te recomiendo leer "${book.title}" de ${book.author}!${basedOnBook ? `\n\nPorque te gust√≥ "${basedOnBook}"` : ''}${comment ? `\n\n"${comment}"` : ''}\n\nüëâ Abr√≠ bibliotecask para verlo: ${appUrl}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Recomendar libro</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        <div className="bg-gray-50 rounded-lg p-3 mb-4">
                            <p className="font-medium">{book.title}</p>
                            <p className="text-sm text-gray-500">{book.author}</p>
                        </div>

                        {friends.length > 0 && (
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Recomendar a amigos en la app:</label>
                                <div className="flex gap-2 flex-wrap">
                                    {friends.map(friend => (
                                        <button key={friend.id} onClick={() => toggleFriend(friend.id)} className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${selectedFriends.includes(friend.id) ? 'bg-gray-100 ring-2 ring-indigo-500' : 'bg-gray-50 hover:bg-gray-100'}`}>
                                            <div className="w-8 h-8 bg-indigo-200 rounded-full flex items-center justify-center text-sm font-medium">
                                                {friend.name?.charAt(0)?.toUpperCase()}
                                            </div>
                                            <span className="text-sm">{friend.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                <span className="flex items-center gap-1.5">
                                    <Icons.Link />
                                    Porque le gust√≥... (opcional)
                                </span>
                            </label>
                            <select
                                value={basedOnBook}
                                onChange={(e) => setBasedOnBook(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 text-sm"
                            >
                                <option value="">Seleccionar un libro</option>
                                {readBooks.map(b => (
                                    <option key={b.id} value={b.title}>{b.title}</option>
                                ))}
                            </select>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Tu comentario (opcional)</label>
                            <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500" rows={2} placeholder="¬øPor qu√© lo recomend√°s?" />
                        </div>

                        <div className="space-y-2">
                            {selectedFriends.length > 0 && (
                                <button onClick={handleSend} disabled={sending} className="w-full bg-gray-900 text-white py-2.5 rounded-lg font-medium hover:bg-gray-800 disabled:opacity-50 flex items-center justify-center gap-2">
                                    {sending ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <><Icons.Share /> Enviar a {selectedFriends.length} amigo{selectedFriends.length > 1 ? 's' : ''}</>}
                                </button>
                            )}

                            <button onClick={shareViaWhatsApp} className="w-full bg-green-500 text-white py-2.5 rounded-lg font-medium hover:bg-green-600 flex items-center justify-center gap-2">
                                <Icons.WhatsApp /> Compartir por WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function InviteModal({ onClose }) {
            const { user, userProfile } = useAuth();
            const appUrl = window.location.origin;

            const shareWhatsApp = () => {
                const message = `üìö ¬°Unite a bibliotecask!\n\n${userProfile?.name || 'Alguien'} te invita a compartir recomendaciones de libros.\n\nüëâ Cre√° tu cuenta gratis: ${appUrl}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const copyLink = () => {
                navigator.clipboard.writeText(appUrl);
                alert('¬°Link copiado!');
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Invitar amigos</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        <p className="text-gray-600 text-sm mb-4">Invit√° a tus amigos para compartir recomendaciones de libros.</p>

                        <div className="space-y-2">
                            <button onClick={shareWhatsApp} className="w-full flex items-center gap-3 px-4 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors">
                                <Icons.WhatsApp />
                                <span className="font-medium">Invitar por WhatsApp</span>
                            </button>

                            <button onClick={copyLink} className="w-full flex items-center gap-3 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                                <Icons.Link />
                                <span className="font-medium">Copiar link de la app</span>
                            </button>
                        </div>

                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg">
                            <p className="text-xs text-gray-800">
                                üí° Cuando tus amigos se registren con el mismo email que les mandaste, van a poder agregarte como amigo.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ ESC√ÅNER DE ESTANTER√çA CON AI ============
        function ScanShelfModal({ onClose, onAddBooks }) {
            const [mediaFile, setMediaFile] = useState(null);
            const [mediaPreview, setMediaPreview] = useState(null);
            const [mediaType, setMediaType] = useState(null); // 'image' or 'video'
            const [scanning, setScanning] = useState(false);
            const [scanProgress, setScanProgress] = useState('');
            const [results, setResults] = useState(null);
            const [error, setError] = useState('');
            const [selectedBooks, setSelectedBooks] = useState([]);
            const fileInputRef = React.useRef(null);
            const videoRef = React.useRef(null);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const isVideo = file.type.startsWith('video/');
                    setMediaFile(file);
                    setMediaType(isVideo ? 'video' : 'image');
                    setMediaPreview(URL.createObjectURL(file));
                    setResults(null);
                    setError('');
                }
            };

            const toBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
            });

            // Extraer frames de un video
            const extractFramesFromVideo = (videoFile, numFrames = 4) => {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.muted = true;
                    video.playsInline = true;

                    video.onloadedmetadata = async () => {
                        const duration = video.duration;
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Tama√±o m√°ximo para no exceder l√≠mites de API
                        const maxSize = 1024;
                        const scale = Math.min(maxSize / video.videoWidth, maxSize / video.videoHeight, 1);
                        canvas.width = video.videoWidth * scale;
                        canvas.height = video.videoHeight * scale;

                        const frames = [];
                        const timestamps = [];

                        // Distribuir frames a lo largo del video
                        for (let i = 0; i < numFrames; i++) {
                            timestamps.push((duration / (numFrames + 1)) * (i + 1));
                        }

                        for (const time of timestamps) {
                            video.currentTime = time;
                            await new Promise(r => video.onseeked = r);
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                            frames.push(base64);
                        }

                        resolve(frames);
                    };

                    video.onerror = reject;
                    video.src = URL.createObjectURL(videoFile);
                });
            };

            const scanBooks = async () => {
                if (!mediaFile) {
                    setError('Seleccion√° una foto o video primero');
                    return;
                }

                setScanning(true);
                setError('');
                setScanProgress('Preparando...');

                try {
                    let images = [];

                    if (mediaType === 'video') {
                        setScanProgress('Extrayendo frames del video...');
                        images = await extractFramesFromVideo(mediaFile, 4);
                        setScanProgress(`Analizando ${images.length} frames ...`);
                    } else {
                        setScanProgress('Analizando imagen ...');
                        const base64 = await toBase64(mediaFile);
                        images = [base64];
                    }

                    const response = await fetch('/.netlify/functions/scan-books', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            images: images,
                            // Mantener compatibilidad con versi√≥n anterior
                            imageBase64: images[0]
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    setResults(data);
                    // Auto-seleccionar libros con confianza alta o media (80%+)
                    const confidentIndexes = data.libros
                        ?.map((libro, i) => (libro.confianza === 'alta' || libro.confianza === 'media') ? i : null)
                        .filter(i => i !== null) || [];
                    setSelectedBooks(confidentIndexes);
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'Error al escanear. Intent√° de nuevo.');
                }
                setScanning(false);
                setScanProgress('');
            };

            const toggleBookSelection = (index) => {
                setSelectedBooks(prev =>
                    prev.includes(index) ? prev.filter(i => i !== index) : [...prev, index]
                );
            };

            const addSelectedBooks = () => {
                const booksToAdd = results.libros
                    .filter((_, i) => selectedBooks.includes(i))
                    .map(libro => ({
                        title: libro.titulo,
                        author: libro.autor || 'Desconocido',
                        cover: ['üìó', 'üìò', 'üìô', 'üìï'][Math.floor(Math.random() * 4)]
                    }));
                onAddBooks(booksToAdd);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icons.Camera /> Escanear estanter√≠a
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        {!results ? (
                            <>
                                <p className="text-sm text-gray-600 mb-4">
                                    Sacale una <strong>foto</strong> o <strong>video</strong> a tu estanter√≠a y los libros se detectar√°n autom√°ticamente.
                                </p>

                                <div
                                    onClick={() => fileInputRef.current?.click()}
                                    className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-400 transition-colors"
                                >
                                    {mediaPreview ? (
                                        mediaType === 'video' ? (
                                            <div className="relative">
                                                <video src={mediaPreview} className="max-h-48 mx-auto rounded-lg" controls />
                                                <div className="mt-2 inline-flex items-center gap-1 bg-purple-100 text-gray-600 px-2 py-1 rounded-full text-xs">
                                                    <Icons.Video /> Video cargado
                                                </div>
                                            </div>
                                        ) : (
                                            <img src={mediaPreview} alt="Preview" className="max-h-48 mx-auto rounded-lg" />
                                        )
                                    ) : (
                                        <>
                                            <div className="flex justify-center gap-4 mb-3">
                                                <div className="bg-indigo-50 rounded-xl p-3">
                                                    <Icons.Camera />
                                                </div>
                                                <div className="bg-purple-50 rounded-xl p-3">
                                                    <Icons.Video />
                                                </div>
                                            </div>
                                            <p className="text-gray-600">Toc√° para subir una <strong>foto</strong> o <strong>video</strong></p>
                                            <p className="text-xs text-gray-400 mt-1">üì∑ JPG, PNG &nbsp;|&nbsp; üé¨ MP4, MOV</p>
                                        </>
                                    )}
                                </div>

                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/jpeg,image/png,image/gif,image/webp,image/heic,video/mp4,video/quicktime,video/webm"
                                    onChange={handleFileSelect}
                                    className="hidden"
                                />

                                {error && (
                                    <div className="mt-4 bg-red-50 text-red-700 p-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <button
                                    onClick={scanBooks}
                                    disabled={scanning || !mediaFile}
                                    className="w-full mt-4 bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-gray-800 disabled:opacity-50 flex items-center justify-center gap-2"
                                >
                                    {scanning ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            {scanProgress || 'Analizando imagen...'}
                                        </>
                                    ) : (
                                        <>
                                            <Icons.Search /> Escanear {mediaType === 'video' ? 'video' : 'foto'}
                                        </>
                                    )}
                                </button>
                            </>
                        ) : (
                            <>
                                <div className="bg-green-50 text-green-800 p-3 rounded-lg mb-4">
                                    ‚úÖ Se encontraron {results.libros?.length || 0} libros
                                </div>

                                {results.notas && (
                                    <p className="text-sm text-gray-500 mb-3 italic">{results.notas}</p>
                                )}

                                {/* Secci√≥n: Libros detectados (alta y media confianza - auto-seleccionados) */}
                                {results.libros?.filter(l => l.confianza === 'alta' || l.confianza === 'media').length > 0 && (
                                    <div className="mb-4">
                                        <h3 className="text-sm font-semibold text-green-700 mb-2 flex items-center gap-1">
                                            ‚úÖ Detectados ({results.libros.filter(l => l.confianza === 'alta' || l.confianza === 'media').length})
                                        </h3>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {results.libros?.map((libro, index) => (libro.confianza === 'alta' || libro.confianza === 'media') && (
                                                <div
                                                    key={index}
                                                    onClick={() => toggleBookSelection(index)}
                                                    className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${
                                                        selectedBooks.includes(index)
                                                            ? 'bg-green-50 ring-2 ring-green-500'
                                                            : 'bg-gray-50 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <div className={`w-5 h-5 rounded flex items-center justify-center ${selectedBooks.includes(index) ? 'bg-green-600' : 'border-2 border-gray-300'}`}>
                                                        {selectedBooks.includes(index) && <Icons.Check />}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="font-medium truncate">{libro.titulo}</p>
                                                        <p className="text-sm text-gray-500 truncate">{libro.autor || 'Autor desconocido'}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Secci√≥n: Libros para revisar (solo baja confianza) */}
                                {results.libros?.filter(l => l.confianza === 'baja').length > 0 && (
                                    <div className="mb-2">
                                        <h3 className="text-sm font-semibold text-amber-700 mb-2 flex items-center gap-1">
                                            ‚ö†Ô∏è Para revisar ({results.libros.filter(l => l.confianza === 'baja').length})
                                        </h3>
                                        <p className="text-xs text-gray-500 mb-2">No estoy seguro de estos. Seleccion√° los correctos:</p>
                                        <div className="space-y-2 max-h-32 overflow-y-auto border-2 border-dashed border-amber-200 rounded-lg p-2">
                                            {results.libros?.map((libro, index) => libro.confianza === 'baja' && (
                                                <div
                                                    key={index}
                                                    onClick={() => toggleBookSelection(index)}
                                                    className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${
                                                        selectedBooks.includes(index)
                                                            ? 'bg-amber-50 ring-2 ring-amber-500'
                                                            : 'bg-gray-50 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <div className={`w-5 h-5 rounded flex items-center justify-center ${selectedBooks.includes(index) ? 'bg-amber-600' : 'border-2 border-gray-300'}`}>
                                                        {selectedBooks.includes(index) && <Icons.Check />}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="font-medium truncate">{libro.titulo}</p>
                                                        <p className="text-sm text-gray-500 truncate">{libro.autor || 'Autor desconocido'}</p>
                                                    </div>
                                                    <span className="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">
                                                        ? dudoso
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-2 mt-4">
                                    <button
                                        onClick={() => { setResults(null); setMediaFile(null); setMediaPreview(null); setMediaType(null); }}
                                        className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200"
                                    >
                                        Escanear otra
                                    </button>
                                    <button
                                        onClick={addSelectedBooks}
                                        disabled={selectedBooks.length === 0}
                                        className="flex-1 bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-gray-800 disabled:opacity-50"
                                    >
                                        Agregar {selectedBooks.length} libros
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // ============ VER BIBLIOTECA DE AMIGO ============
        function RequestLibraryAccessModal({ onClose }) {
            const { user, userProfile } = useAuth();
            const [email, setEmail] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);

            const handleRequestAccess = async () => {
                if (!email.trim()) return;
                setLoading(true);
                setError('');

                try {
                    const usersSnapshot = await db.collection('users').where('email', '==', email.toLowerCase().trim()).get();

                    if (usersSnapshot.empty) {
                        setError('No encontramos un usuario con ese email');
                        setLoading(false);
                        return;
                    }

                    const targetUser = usersSnapshot.docs[0];
                    const targetUserId = targetUser.id;

                    if (targetUserId === user.uid) {
                        setError('No pod√©s solicitar acceso a tu propia biblioteca');
                        setLoading(false);
                        return;
                    }

                    // Verificar si ya tiene acceso
                    const existingAccess = await db.collection('users').doc(targetUserId)
                        .collection('libraryAccess').doc(user.uid).get();

                    if (existingAccess.exists) {
                        setError('Ya ten√©s acceso a esta biblioteca');
                        setLoading(false);
                        return;
                    }

                    // Verificar si ya hay una solicitud pendiente
                    const existingRequest = await db.collection('users').doc(targetUserId)
                        .collection('libraryAccessRequests').doc(user.uid).get();

                    if (existingRequest.exists) {
                        setError('Ya enviaste una solicitud a este usuario');
                        setLoading(false);
                        return;
                    }

                    // Crear solicitud
                    await db.collection('users').doc(targetUserId).collection('libraryAccessRequests').doc(user.uid).set({
                        fromUserId: user.uid,
                        fromName: userProfile?.name || 'Alguien',
                        fromEmail: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    });

                    setSuccess(true);
                    setTimeout(() => onClose(), 2000);
                } catch (err) {
                    console.error(err);
                    setError('Error al enviar solicitud');
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Ver biblioteca de amigo</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        {success ? (
                            <div className="text-center py-4">
                                <span className="text-4xl">üì®</span>
                                <p className="font-medium mt-2">¬°Solicitud enviada!</p>
                                <p className="text-sm text-gray-500">Te avisaremos cuando te acepten</p>
                            </div>
                        ) : (
                            <>
                                <p className="text-gray-600 text-sm mb-4">Ingres√° el email de tu amigo para pedirle acceso a ver su biblioteca.</p>

                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 mb-3"
                                    placeholder="amigo@email.com"
                                />

                                {error && <p className="text-red-600 text-sm mb-3">{error}</p>}

                                <button
                                    onClick={handleRequestAccess}
                                    disabled={loading || !email.trim()}
                                    className="w-full bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-gray-800 disabled:opacity-50"
                                >
                                    {loading ? 'Enviando...' : 'Solicitar acceso'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function ViewFriendLibraryModal({ friend, onClose }) {
            const [books, setBooks] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadBooks = async () => {
                    const snapshot = await db.collection('users').doc(friend.id)
                        .collection('books').get();
                    const booksData = snapshot.docs
                        .filter(doc => doc.id !== '_init')
                        .map(doc => ({ id: doc.id, ...doc.data() }));
                    setBooks(booksData);
                    setLoading(false);
                };
                loadBooks();
            }, [friend.id]);

            const readBooks = books.filter(b => b.read);
            const unreadBooks = books.filter(b => !b.read);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center text-lg font-medium">
                                    {friend.name?.charAt(0)?.toUpperCase()}
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold">Biblioteca de {friend.name}</h2>
                                    <p className="text-sm text-gray-500">{books.length} libros</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        {loading ? (
                            <div className="text-center py-8">
                                <div className="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                            </div>
                        ) : books.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                <span className="text-4xl">üìö</span>
                                <p className="mt-2">{friend.name} todav√≠a no tiene libros</p>
                            </div>
                        ) : (
                            <>
                                {readBooks.length > 0 && (
                                    <div className="mb-4">
                                        <h3 className="font-medium text-green-700 mb-2">‚úì Le√≠dos ({readBooks.length})</h3>
                                        <div className="space-y-2">
                                            {readBooks.map(book => (
                                                <div key={book.id} className="flex items-center gap-3 bg-green-50 p-3 rounded-lg">
                                                    {book.cover?.startsWith('http') ? (
                                                        <img src={book.cover} alt={book.title} className="w-12 h-16 object-cover rounded shadow" />
                                                    ) : (
                                                        <span className="text-2xl">{book.cover || 'üìó'}</span>
                                                    )}
                                                    <div>
                                                        <p className="font-medium">{book.title}</p>
                                                        <p className="text-sm text-gray-500">{book.author}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {unreadBooks.length > 0 && (
                                    <div>
                                        <h3 className="font-medium text-gray-700 mb-2">Por leer ({unreadBooks.length})</h3>
                                        <div className="space-y-2">
                                            {unreadBooks.map(book => (
                                                <div key={book.id} className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
                                                    {book.cover?.startsWith('http') ? (
                                                        <img src={book.cover} alt={book.title} className="w-12 h-16 object-cover rounded shadow" />
                                                    ) : (
                                                        <span className="text-2xl">{book.cover || 'üìó'}</span>
                                                    )}
                                                    <div>
                                                        <p className="font-medium">{book.title}</p>
                                                        <p className="text-sm text-gray-500">{book.author}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function AddFriendModal({ onClose }) {
            const { user } = useAuth();
            const [email, setEmail] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);

            const handleAddFriend = async () => {
                if (!email.trim()) return;
                setLoading(true);
                setError('');

                try {
                    // Buscar usuario por email
                    const usersSnapshot = await db.collection('users').where('email', '==', email.toLowerCase().trim()).get();

                    if (usersSnapshot.empty) {
                        setError('No encontramos un usuario con ese email. ¬°Invitalo a la app!');
                        setLoading(false);
                        return;
                    }

                    const friendDoc = usersSnapshot.docs[0];
                    const friendId = friendDoc.id;

                    if (friendId === user.uid) {
                        setError('No pod√©s agregarte a vos mismo');
                        setLoading(false);
                        return;
                    }

                    // Agregar a la lista de amigos de ambos usuarios
                    await db.collection('users').doc(user.uid).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(friendId)
                    });

                    await db.collection('users').doc(friendId).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(user.uid)
                    });

                    setSuccess(true);
                    setTimeout(() => onClose(), 1500);
                } catch (err) {
                    console.error(err);
                    setError('Error al agregar amigo');
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Agregar amigo</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>

                        {success ? (
                            <div className="text-center py-4">
                                <span className="text-4xl">üéâ</span>
                                <p className="font-medium mt-2">¬°Amigo agregado!</p>
                            </div>
                        ) : (
                            <>
                                <p className="text-gray-600 text-sm mb-4">Ingres√° el email de tu amigo que ya usa la app.</p>

                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 mb-3"
                                    placeholder="amigo@email.com"
                                />

                                {error && <p className="text-red-600 text-sm mb-3">{error}</p>}

                                <button
                                    onClick={handleAddFriend}
                                    disabled={loading || !email.trim()}
                                    className="w-full bg-gray-900 text-white py-3 rounded-xl font-medium hover:bg-gray-800 disabled:opacity-50"
                                >
                                    {loading ? 'Buscando...' : 'Agregar amigo'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // ============ APP PRINCIPAL ============
        function MainApp() {
            const { user, userProfile, signOut, setUserProfile } = useAuth();
            const [books, setBooks] = useState([]);
            const [friends, setFriends] = useState([]);
            const [recommendations, setRecommendations] = useState([]);
            const [wishlist, setWishlist] = useState([]);
            const [activeTab, setActiveTab] = useState('biblioteca');
            const [showAddModal, setShowAddModal] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [showAddFriendModal, setShowAddFriendModal] = useState(false);
            const [recommendBook, setRecommendBook] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filter, setFilter] = useState('todos');
            const [showAddOptions, setShowAddOptions] = useState(false);
            const [showScanModal, setShowScanModal] = useState(false);
            const [showRequestAccessModal, setShowRequestAccessModal] = useState(false);
            const [viewingFriend, setViewingFriend] = useState(null);
            const [libraryAccessRequests, setLibraryAccessRequests] = useState([]);
            const [approvedViewers, setApprovedViewers] = useState([]);
            const [friendsBooks, setFriendsBooks] = useState([]);
            const [aiRecommendations, setAiRecommendations] = useState([]);
            const [loadingAiRecs, setLoadingAiRecs] = useState(false);
            const [loading, setLoading] = useState(true);

            // Cargar datos del usuario desde Firestore
            useEffect(() => {
                if (!user) return;

                const unsubscribeBooks = db.collection('users').doc(user.uid).collection('books')
                    .onSnapshot(snapshot => {
                        const booksData = snapshot.docs
                            .filter(doc => doc.id !== '_init')
                            .map(doc => ({ id: doc.id, ...doc.data() }));
                        setBooks(booksData);
                        setLoading(false);
                    });

                const unsubscribeRecs = db.collection('users').doc(user.uid).collection('recommendations')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        setRecommendations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                const unsubscribeWishlist = db.collection('users').doc(user.uid).collection('wishlist')
                    .onSnapshot(snapshot => {
                        setWishlist(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                return () => {
                    unsubscribeBooks();
                    unsubscribeRecs();
                    unsubscribeWishlist();
                };
            }, [user]);

            // Cargar amigos
            useEffect(() => {
                if (!userProfile?.friends?.length) {
                    setFriends([]);
                    return;
                }

                const loadFriends = async () => {
                    const friendsData = [];
                    for (const friendId of userProfile.friends) {
                        const doc = await db.collection('users').doc(friendId).get();
                        if (doc.exists) {
                            friendsData.push({ id: friendId, ...doc.data() });
                        }
                    }
                    setFriends(friendsData);
                };
                loadFriends();
            }, [userProfile?.friends]);

            // Cargar libros de amigos
            useEffect(() => {
                if (!friends.length) {
                    setFriendsBooks([]);
                    return;
                }

                const loadFriendsBooks = async () => {
                    const allFriendsBooks = [];
                    for (const friend of friends) {
                        const snapshot = await db.collection('users').doc(friend.id).collection('books').get();
                        const friendBooks = snapshot.docs
                            .filter(doc => doc.id !== '_init')
                            .map(doc => ({
                                id: doc.id,
                                ...doc.data(),
                                friendId: friend.id,
                                friendName: friend.name
                            }));
                        allFriendsBooks.push(...friendBooks);
                    }
                    setFriendsBooks(allFriendsBooks);
                };
                loadFriendsBooks();
            }, [friends]);

            // Cargar solicitudes de acceso a biblioteca
            useEffect(() => {
                if (!user) return;

                const unsubscribeRequests = db.collection('users').doc(user.uid)
                    .collection('libraryAccessRequests')
                    .where('status', '==', 'pending')
                    .onSnapshot(snapshot => {
                        setLibraryAccessRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });

                const unsubscribeViewers = db.collection('users').doc(user.uid)
                    .collection('libraryAccess')
                    .onSnapshot(async (snapshot) => {
                        const viewersData = [];
                        for (const doc of snapshot.docs) {
                            const userDoc = await db.collection('users').doc(doc.id).get();
                            if (userDoc.exists) {
                                viewersData.push({ id: doc.id, ...userDoc.data() });
                            }
                        }
                        setApprovedViewers(viewersData);
                    });

                return () => {
                    unsubscribeRequests();
                    unsubscribeViewers();
                };
            }, [user]);

            // Aprobar/rechazar solicitud de acceso
            const handleAccessRequest = async (requestId, approve) => {
                const request = libraryAccessRequests.find(r => r.id === requestId);
                if (approve && request) {
                    await db.collection('users').doc(user.uid).collection('libraryAccess').doc(requestId).set({
                        name: request.fromName || request.requesterName || 'Usuario',
                        email: request.fromEmail || request.requesterEmail || '',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await db.collection('users').doc(user.uid).collection('libraryAccessRequests').doc(requestId).delete();
            };

            // Buscar tapa de libro en Google Books
            const fetchBookCover = async (title, author) => {
                try {
                    const query = encodeURIComponent(`${title} ${author}`);
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1`);
                    const data = await response.json();
                    if (data.items && data.items[0]?.volumeInfo?.imageLinks?.thumbnail) {
                        // Convertir a HTTPS y mejor calidad
                        return data.items[0].volumeInfo.imageLinks.thumbnail.replace('http://', 'https://');
                    }
                } catch (err) {
                    console.log('No se pudo obtener la tapa:', err);
                }
                return null;
            };

            // Verificar si un libro ya existe (similar)
            const findSimilarBook = (title, author) => {
                const normalize = (str) => str?.toLowerCase().trim().replace(/[^\w\s]/g, '') || '';
                const titleNorm = normalize(title);
                const authorNorm = normalize(author);

                return books.find(b => {
                    const existingTitle = normalize(b.title);
                    const existingAuthor = normalize(b.author);
                    // Coincidencia exacta o muy similar
                    return existingTitle === titleNorm ||
                           (existingTitle.includes(titleNorm) || titleNorm.includes(existingTitle)) &&
                           (existingAuthor.includes(authorNorm) || authorNorm.includes(existingAuthor));
                });
            };

            // Funciones de libros
            const addBook = async ({ title, author, cover }, skipDuplicateCheck = false) => {
                // Verificar duplicados
                if (!skipDuplicateCheck) {
                    const existing = findSimilarBook(title, author);
                    if (existing) {
                        console.log(`Libro duplicado ignorado: ${title}`);
                        return { skipped: true, existing };
                    }
                }

                // Si no hay cover o es emoji, buscar en Google Books
                let finalCover = cover;
                if (!cover || cover.length <= 2) {
                    finalCover = await fetchBookCover(title, author);
                }
                await db.collection('users').doc(user.uid).collection('books').add({
                    title, author, cover: finalCover, read: false, ratings: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return { skipped: false };
            };

            const addMultipleBooks = async (booksToAdd) => {
                const results = { added: 0, skipped: 0, duplicates: [] };
                for (const book of booksToAdd) {
                    const existing = findSimilarBook(book.title, book.author);
                    if (existing) {
                        results.skipped++;
                        results.duplicates.push({ new: book, existing });
                    } else {
                        await addBook(book, true);
                        results.added++;
                    }
                }
                if (results.skipped > 0) {
                    alert(`Se agregaron ${results.added} libros.\n${results.skipped} libros ya estaban en tu biblioteca.`);
                }
                return results;
            };

            // Obtener recomendaciones con IA
            const fetchAiRecommendations = async () => {
                if (books.length < 3) {
                    alert('Agreg√° al menos 3 libros para obtener recomendaciones personalizadas');
                    return;
                }
                setLoadingAiRecs(true);
                try {
                    const response = await fetch('/.netlify/functions/recommend-books', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ books: books.slice(0, 20) }) // M√°ximo 20 libros
                    });
                    const data = await response.json();
                    if (data.recommendations) {
                        setAiRecommendations(data.recommendations);
                    }
                } catch (err) {
                    console.error('Error obteniendo recomendaciones:', err);
                    alert('Error al obtener recomendaciones');
                }
                setLoadingAiRecs(false);
            };

            // Agregar recomendaci√≥n de IA a wishlist
            const addAiRecToWishlist = async (rec) => {
                const cover = await fetchBookCover(rec.title, rec.author);
                await db.collection('users').doc(user.uid).collection('wishlist').add({
                    title: rec.title,
                    author: rec.author,
                    cover: cover,
                    recommendedBy: 'IA',
                    reason: rec.reason,
                    amazonLink: rec.amazonLink,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Quitar de la lista de recomendaciones
                setAiRecommendations(prev => prev.filter(r => r.title !== rec.title));
                alert(`"${rec.title}" agregado a tu lista de compras`);
            };

            const toggleRead = async (bookId) => {
                const book = books.find(b => b.id === bookId);
                await db.collection('users').doc(user.uid).collection('books').doc(bookId).update({
                    read: !book.read
                });
            };

            const rateBook = async (bookId, ratings) => {
                await db.collection('users').doc(user.uid).collection('books').doc(bookId).update({ ratings });
            };

            const addFromRecommendation = async (rec, toWishlist = false) => {
                if (toWishlist) {
                    await db.collection('users').doc(user.uid).collection('wishlist').add({
                        title: rec.bookTitle,
                        author: rec.bookAuthor,
                        recommendedBy: rec.fromName,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await addBook({ title: rec.bookTitle, author: rec.bookAuthor, cover: 'üìó' });
                }
                // Eliminar recomendaci√≥n
                await db.collection('users').doc(user.uid).collection('recommendations').doc(rec.id).delete();
            };

            const buyBook = async (book) => {
                await addBook({ title: book.title, author: book.author, cover: 'üìó' });
                await db.collection('users').doc(user.uid).collection('wishlist').doc(book.id).delete();
            };

            const removeFromWishlist = async (id) => {
                await db.collection('users').doc(user.uid).collection('wishlist').doc(id).delete();
            };

            // Borrar un libro
            const deleteBook = async (bookId) => {
                if (confirm('¬øSeguro que quer√©s eliminar este libro?')) {
                    await db.collection('users').doc(user.uid).collection('books').doc(bookId).delete();
                }
            };

            // Borrar toda la biblioteca
            const deleteAllBooks = async () => {
                if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto borrar√° TODOS tus libros.')) {
                    if (confirm('Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                        const batch = db.batch();
                        const snapshot = await db.collection('users').doc(user.uid).collection('books').get();
                        snapshot.docs.forEach(doc => {
                            if (doc.id !== '_init') {
                                batch.delete(doc.ref);
                            }
                        });
                        await batch.commit();
                        alert('Biblioteca vaciada');
                    }
                }
            };

            const filteredBooks = books.filter(book => {
                const matchesSearch = book.title?.toLowerCase().includes(searchTerm.toLowerCase()) || book.author?.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesFilter = filter === 'todos' || (filter === 'leidos' && book.read) || (filter === 'pendientes' && !book.read);
                return matchesSearch && matchesFilter;
            });

            const stats = { total: books.length, leidos: books.filter(b => b.read).length, pendientes: books.filter(b => !b.read).length };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando tu biblioteca...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="gradient-bg text-white">
                        <div className="max-w-2xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <span className="text-3xl">üìö</span>
                                    <div>
                                        <h1 className="text-xl font-bold">Hola, {userProfile?.name?.split(' ')[0] || 'Usuario'}</h1>
                                        <p className="text-indigo-200 text-sm">{stats.leidos} le√≠dos ¬∑ {stats.pendientes} pendientes</p>
                                    </div>
                                </div>

                                <div className="flex items-center gap-2">
                                    <div className="relative">
                                        <button onClick={() => setShowAddOptions(!showAddOptions)} className="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors">
                                            <Icons.Plus />
                                        </button>
                                        {showAddOptions && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setShowAddOptions(false)} />
                                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border z-50 overflow-hidden">
                                                    <button onClick={() => { setShowAddOptions(false); setShowAddModal(true); }} className="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-gray-50">
                                                        <span className="text-gray-700"><Icons.Plus /></span>
                                                        <span>Agregar libro</span>
                                                    </button>
                                                    <button onClick={() => { setShowAddOptions(false); setShowScanModal(true); }} className="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-gray-50 border-t">
                                                        <span className="text-purple-600"><Icons.Camera /></span>
                                                        <span>Escanear estanter√≠a</span>
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    <button onClick={signOut} className="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors">
                                        <Icons.Logout />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-0 z-10">
                        <div className="max-w-2xl mx-auto px-4">
                            <div className="flex">
                                {[
                                    { id: 'biblioteca', label: 'bibliotecask', icon: Icons.Book },
                                    { id: 'comprar', label: `Lista de compras${wishlist.length ? ` (${wishlist.length})` : ''}`, icon: () => <span>üõí</span> },
                                    { id: 'amigos', label: 'Amigos', icon: Icons.Users },
                                    { id: 'recomendaciones', label: 'Recomendaciones', icon: () => <span>üí°</span> }
                                ].map(({ id, label, icon: Icon }) => (
                                    <button key={id} onClick={() => setActiveTab(id)} className={`flex-1 flex items-center justify-center gap-1 py-3 border-b-2 transition-colors text-xs sm:text-sm ${activeTab === id ? 'border-indigo-600 text-gray-700' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                        <Icon /> <span className="text-sm">{label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-2xl mx-auto px-4 py-6">
                        {activeTab === 'biblioteca' && (
                            <>
                                <div className="flex gap-2 mb-4">
                                    <div className="flex-1 relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Search /></span>
                                        <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar..." className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-500" />
                                    </div>
                                    <select value={filter} onChange={(e) => setFilter(e.target.value)} className="px-3 py-2 border border-gray-200 rounded-lg text-gray-700">
                                        <option value="todos">Todos</option>
                                        <option value="leidos">Le√≠dos</option>
                                        <option value="pendientes">Por leer</option>
                                    </select>
                                    {books.length > 0 && (
                                        <button onClick={deleteAllBooks} className="text-gray-400 hover:text-red-500 p-2" title="Vaciar biblioteca">
                                            üóëÔ∏è
                                        </button>
                                    )}
                                </div>

                                {/* Banner de escaneo - siempre visible si hay pocos libros */}
                                {books.length < 10 && (
                                    <div
                                        onClick={() => setShowScanModal(true)}
                                        className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-5 mb-4 cursor-pointer hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg"
                                    >
                                        <div className="flex items-center gap-4">
                                            <div className="bg-white/20 rounded-xl p-3">
                                                <span className="text-3xl">üì∏</span>
                                            </div>
                                            <div className="flex-1 text-white">
                                                <h3 className="font-bold text-lg">¬°Escane√° tu estanter√≠a!</h3>
                                                <p className="text-purple-100 text-sm">Sac√° una foto o video y agregamos todos tus libros autom√°ticamente</p>
                                            </div>
                                            <div className="text-white/80">
                                                <Icons.ChevronRight />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {books.length === 0 ? (
                                    <div className="text-center py-8">
                                        <span className="text-6xl block mb-4">üìö</span>
                                        <h3 className="font-medium text-gray-900 mb-2">Tu biblioteca est√° vac√≠a</h3>
                                        <p className="text-gray-500 mb-6">Empez√° escaneando tu estanter√≠a o agreg√° libros manualmente</p>
                                        <div className="flex flex-col gap-3 max-w-xs mx-auto">
                                            <button onClick={() => setShowScanModal(true)} className="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 font-medium flex items-center justify-center gap-2">
                                                <Icons.Camera /> Escanear estanter√≠a
                                            </button>
                                            <button onClick={() => setShowAddModal(true)} className="bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200">
                                                Agregar manualmente
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredBooks.map(book => (
                                            <BookCard key={book.id} book={book} onToggleRead={toggleRead} onRate={rateBook} onRecommend={setRecommendBook} onDelete={deleteBook} />
                                        ))}
                                        {filteredBooks.length === 0 && (
                                            <div className="text-center py-12 text-gray-500">
                                                <p>No se encontraron libros</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}

                        {activeTab === 'comprar' && (
                            <div className="space-y-4">
                                <h2 className="text-lg font-semibold text-gray-900">Lista de compras</h2>

                                {wishlist.length > 0 ? (
                                    wishlist.map(book => (
                                        <div key={book.id} className="bg-white rounded-xl p-4 border shadow-sm">
                                            <div className="flex items-start gap-3">
                                                {book.cover?.startsWith('http') ? (
                                                    <img src={book.cover} alt={book.title} className="w-12 h-16 object-cover rounded shadow" />
                                                ) : (
                                                    <span className="text-3xl">üõí</span>
                                                )}
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-gray-900">{book.title}</h4>
                                                    <p className="text-sm text-gray-500">{book.author}</p>
                                                    {book.recommendedBy && <p className="text-xs text-purple-600 mt-1">Recomendado por {book.recommendedBy}</p>}
                                                </div>
                                            </div>
                                            <div className="flex gap-2 mt-3">
                                                <a
                                                    href={book.amazonLink || `https://www.amazon.com/s?k=${encodeURIComponent(book.title + ' ' + book.author)}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="flex-1 bg-yellow-500 text-white text-sm py-2 rounded-lg hover:bg-yellow-600 text-center"
                                                >
                                                    üõí Comprar en Amazon
                                                </a>
                                                <button onClick={() => buyBook(book)} className="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm">‚úì Comprado</button>
                                                <button onClick={() => removeFromWishlist(book.id)} className="px-3 py-2 text-gray-400 hover:text-red-500"><Icons.X /></button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-12 text-gray-500">
                                        <span className="text-5xl block mb-3">üõí</span>
                                        <p>Tu lista de compras est√° vac√≠a</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'amigos' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-semibold text-gray-900">Libros de amigos</h2>
                                    <button onClick={() => setShowAddFriendModal(true)} className="text-gray-700 text-sm font-medium">
                                        + Agregar amigo
                                    </button>
                                </div>

                                {/* Compartir bibliotecask */}
                                <div className="bg-purple-50 rounded-xl p-4 border border-purple-200">
                                    <h3 className="font-medium text-gray-900 mb-2">üîó Compart√≠ tu biblioteca</h3>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            readOnly
                                            value={`${window.location.origin}?ver=${user.uid}`}
                                            className="flex-1 text-xs bg-white border rounded-lg px-2 py-2 text-gray-600"
                                        />
                                        <button
                                            onClick={() => {
                                                navigator.clipboard.writeText(`${window.location.origin}?ver=${user.uid}`);
                                                alert('¬°Link copiado!');
                                            }}
                                            className="bg-purple-600 text-white text-xs px-3 py-2 rounded-lg hover:bg-purple-700"
                                        >
                                            Copiar
                                        </button>
                                    </div>
                                </div>

                                {friends.length === 0 ? (
                                    <div className="text-center py-8 text-gray-500">
                                        <span className="text-5xl block mb-3">üë•</span>
                                        <p>Todav√≠a no ten√©s amigos agregados</p>
                                        <button onClick={() => setShowInviteModal(true)} className="mt-3 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg">
                                            Invitar por WhatsApp
                                        </button>
                                    </div>
                                ) : friendsBooks.length === 0 ? (
                                    <div className="text-center py-8 text-gray-500">
                                        <span className="text-5xl block mb-3">üìö</span>
                                        <p>Tus amigos a√∫n no tienen libros</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {friends.map(friend => {
                                            const friendBooksList = friendsBooks.filter(b => b.friendId === friend.id);
                                            if (friendBooksList.length === 0) return null;
                                            return (
                                                <div key={friend.id} className="bg-white rounded-xl border overflow-hidden">
                                                    <div className="bg-gray-50 px-4 py-2 border-b flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-8 h-8 bg-indigo-200 rounded-full flex items-center justify-center text-sm font-medium">
                                                                {friend.name?.charAt(0)?.toUpperCase()}
                                                            </div>
                                                            <span className="font-medium">{friend.name}</span>
                                                            <span className="text-xs text-gray-500">({friendBooksList.length} libros)</span>
                                                        </div>
                                                        <button onClick={() => setViewingFriend(friend)} className="text-gray-700 text-xs">Ver todo ‚Üí</button>
                                                    </div>
                                                    <div className="p-3 flex gap-2 overflow-x-auto">
                                                        {friendBooksList.slice(0, 5).map(book => (
                                                            <div key={book.id} className="flex-shrink-0 w-20 text-center">
                                                                {book.cover && book.cover.startsWith('http') ? (
                                                                    <img src={book.cover} alt={book.title} className="w-16 h-20 object-cover rounded shadow mx-auto" />
                                                                ) : (
                                                                    <div className="w-16 h-20 bg-gray-100 rounded flex items-center justify-center text-2xl mx-auto">{book.cover || 'üìö'}</div>
                                                                )}
                                                                <p className="text-xs text-gray-700 mt-1 truncate">{book.title}</p>
                                                            </div>
                                                        ))}
                                                        {friendBooksList.length > 5 && (
                                                            <div className="flex-shrink-0 w-20 flex items-center justify-center">
                                                                <button onClick={() => setViewingFriend(friend)} className="text-gray-700 text-sm">+{friendBooksList.length - 5}</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'recomendaciones' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-semibold text-gray-900">Recomendaciones</h2>
                                    <button
                                        onClick={fetchAiRecommendations}
                                        disabled={loadingAiRecs}
                                        className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm px-4 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {loadingAiRecs ? (
                                            <>
                                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                Pensando...
                                            </>
                                        ) : (
                                            <>ü§ñ Pedirle a la IA</>
                                        )}
                                    </button>
                                </div>

                                {/* Recomendaciones de IA */}
                                {aiRecommendations.length > 0 && (
                                    <div className="bg-gradient-to-r from-gray-50 to-pink-50 rounded-xl p-4 border border-purple-200">
                                        <h3 className="font-medium text-gray-900 mb-3">ü§ñ Recomendaciones personalizadas</h3>
                                        <div className="space-y-3">
                                            {aiRecommendations.map((rec, idx) => (
                                                <div key={idx} className="bg-white rounded-lg p-3 border flex items-start gap-3">
                                                    <div className="flex-1">
                                                        <h4 className="font-medium text-gray-900">{rec.title}</h4>
                                                        <p className="text-sm text-gray-500">{rec.author}</p>
                                                        <p className="text-xs text-purple-600 mt-1 italic">"{rec.reason}"</p>
                                                        <div className="flex gap-2 mt-2">
                                                            <button
                                                                onClick={() => addAiRecToWishlist(rec)}
                                                                className="bg-gray-100 text-indigo-700 text-xs px-3 py-1 rounded-full hover:bg-indigo-200"
                                                            >
                                                                + Lista de compras
                                                            </button>
                                                            <a
                                                                href={rec.amazonLink}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full hover:bg-yellow-200 flex items-center gap-1"
                                                            >
                                                                üõí Amazon
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Recomendaciones de amigos */}
                                {recommendations.length > 0 && (
                                    <div>
                                        <h3 className="font-medium text-gray-900 mb-3">üë• De tus amigos</h3>
                                        {recommendations.map(rec => (
                                            <FriendRecommendation key={rec.id} rec={rec} onAddToList={(r) => addFromRecommendation(r, false)} onAddToWishlist={(r) => addFromRecommendation(r, true)} />
                                        ))}
                                    </div>
                                )}

                                {aiRecommendations.length === 0 && recommendations.length === 0 && (
                                    <div className="text-center py-8 text-gray-500">
                                        <span className="text-5xl block mb-3">üí°</span>
                                        <p>Toc√° "Pedirle a la IA" para obtener recomendaciones</p>
                                        <p className="text-sm mt-2">basadas en tu biblioteca</p>
                                    </div>
                                )}

                                {/* Libros populares entre amigos */}
                                {friendsBooks.length > 0 && (
                                    <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-100">
                                        <h3 className="font-medium text-indigo-900 mb-3">üìä Populares entre tus amigos</h3>
                                        <div className="space-y-2">
                                            {Object.entries(
                                                friendsBooks.reduce((acc, book) => {
                                                    const key = book.title?.toLowerCase();
                                                    if (!acc[key]) acc[key] = { ...book, count: 0, friends: [] };
                                                    acc[key].count++;
                                                    if (!acc[key].friends.includes(book.friendName)) acc[key].friends.push(book.friendName);
                                                    return acc;
                                                }, {})
                                            )
                                            .filter(([_, b]) => b.count > 1)
                                            .sort((a, b) => b[1].count - a[1].count)
                                            .slice(0, 5)
                                            .map(([key, book]) => (
                                                <div key={key} className="flex items-center gap-3 bg-white rounded-lg p-2">
                                                    {book.cover && book.cover.startsWith('http') ? (
                                                        <img src={book.cover} alt={book.title} className="w-10 h-12 object-cover rounded" />
                                                    ) : (
                                                        <span className="text-2xl">{book.cover || 'üìö'}</span>
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <p className="font-medium text-sm truncate">{book.title}</p>
                                                        <p className="text-xs text-gray-500">{book.count} amigos lo tienen</p>
                                                    </div>
                                                </div>
                                            ))}
                                            {Object.values(friendsBooks.reduce((acc, book) => {
                                                const key = book.title?.toLowerCase();
                                                if (!acc[key]) acc[key] = { count: 0 };
                                                acc[key].count++;
                                                return acc;
                                            }, {})).filter(b => b.count > 1).length === 0 && (
                                                <p className="text-sm text-indigo-700">Todav√≠a no hay libros en com√∫n entre tus amigos</p>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                                    <h3 className="font-medium text-indigo-900 mb-2">üì≤ Invit√° m√°s amigos</h3>
                                    <p className="text-sm text-indigo-700 mb-3">M√°s amigos = mejores recomendaciones</p>
                                    <button onClick={() => setShowInviteModal(true)} className="bg-gray-900 text-white text-sm px-4 py-2 rounded-lg hover:bg-gray-800">
                                        Invitar por WhatsApp
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    {showAddModal && <AddBookModal onClose={() => setShowAddModal(false)} onAdd={addBook} />}
                    {showInviteModal && <InviteModal onClose={() => setShowInviteModal(false)} />}
                    {showAddFriendModal && <AddFriendModal onClose={() => setShowAddFriendModal(false)} />}
                    {showScanModal && <ScanShelfModal onClose={() => setShowScanModal(false)} onAddBooks={addMultipleBooks} />}
                    {recommendBook && <RecommendModal book={recommendBook} friends={friends} myBooks={books} onClose={() => setRecommendBook(null)} onSend={() => setRecommendBook(null)} />}
                    {showRequestAccessModal && <RequestLibraryAccessModal onClose={() => setShowRequestAccessModal(false)} />}
                    {viewingFriend && <ViewFriendLibraryModal friend={viewingFriend} onClose={() => setViewingFriend(null)} />}
                </div>
            );
        }

        // ============ VISTA P√öBLICA DE BIBLIOTECA ============
        function PublicLibraryView({ userId }) {
            const { user } = useAuth();
            const [owner, setOwner] = useState(null);
            const [books, setBooks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [addedBooks, setAddedBooks] = useState(new Set());

            useEffect(() => {
                const loadLibrary = async () => {
                    try {
                        // Cargar info del due√±o
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (!userDoc.exists) {
                            setError('Usuario no encontrado');
                            setLoading(false);
                            return;
                        }
                        setOwner(userDoc.data());

                        // Cargar libros
                        const booksSnapshot = await db.collection('users').doc(userId).collection('books').get();
                        const booksData = booksSnapshot.docs
                            .filter(doc => doc.id !== '_init')
                            .map(doc => ({ id: doc.id, ...doc.data() }));
                        setBooks(booksData);
                    } catch (err) {
                        setError('Error al cargar la biblioteca');
                    }
                    setLoading(false);
                };
                loadLibrary();
            }, [userId]);

            const addToMyWishlist = async (book) => {
                if (!user) {
                    alert('Ten√©s que iniciar sesi√≥n para agregar libros');
                    return;
                }
                try {
                    await db.collection('users').doc(user.uid).collection('wishlist').add({
                        title: book.title,
                        author: book.author,
                        cover: book.cover,
                        recommendedBy: owner?.name || 'Un amigo',
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setAddedBooks(prev => new Set([...prev, book.id]));
                } catch (err) {
                    alert('Error al agregar el libro');
                }
            };

            const readBooks = books.filter(b => b.read);
            const unreadBooks = books.filter(b => !b.read);

            const BookCard = ({ book }) => {
                const avg = calculateAverage(book.ratings);
                return (
                    <div className="bg-white rounded-xl p-4 border flex items-center gap-3">
                        {book.cover && book.cover.startsWith('http') ? (
                            <img src={book.cover} alt={book.title} className="w-12 h-16 object-cover rounded shadow-sm" />
                        ) : (
                            <span className="text-3xl">{book.cover || 'üìó'}</span>
                        )}
                        <div className="flex-1">
                            <h3 className="font-medium">{book.title}</h3>
                            <p className="text-sm text-gray-500">{book.author}</p>
                            {avg && (
                                <div className="flex items-center gap-1 mt-1">
                                    <span className="text-yellow-500 text-sm">‚òÖ</span>
                                    <span className="text-sm font-medium text-gray-700">{avg}</span>
                                    <span className="text-xs text-gray-400">/ 5</span>
                                </div>
                            )}
                        </div>
                        {user && user.uid !== userId && (
                            addedBooks.has(book.id) ? (
                                <span className="text-green-600 text-sm">‚úì Agregado</span>
                            ) : (
                                <button
                                    onClick={() => addToMyWishlist(book)}
                                    className="bg-gray-100 text-indigo-700 text-xs px-3 py-1 rounded-full hover:bg-indigo-200"
                                >
                                    + Mi lista
                                </button>
                            )
                        )}
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-bg">
                        <div className="text-center text-white">
                            <span className="text-6xl block mb-4">üìö</span>
                            <div className="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-bg">
                        <div className="text-center text-white">
                            <span className="text-6xl block mb-4">üòï</span>
                            <p className="text-xl">{error}</p>
                            <a href="/" className="mt-4 inline-block bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30">
                                Ir al inicio
                            </a>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="gradient-bg text-white">
                        <div className="max-w-2xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl">
                                        {owner?.name?.charAt(0)?.toUpperCase() || 'üìö'}
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">Biblioteca de {owner?.name}</h1>
                                        <p className="text-white/80 text-sm">{books.length} libros ‚Ä¢ {readBooks.length} le√≠dos</p>
                                    </div>
                                </div>
                                {user && (
                                    <a href="/" className="bg-white/20 px-3 py-1 rounded-lg text-sm hover:bg-white/30">
                                        bibliotecask
                                    </a>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto px-4 py-6">
                        {user && user.uid !== userId && (
                            <div className="bg-indigo-50 rounded-xl p-3 mb-4 text-center text-sm text-indigo-700">
                                üí° Toc√° "+ Mi lista" en cualquier libro para agregarlo a tu lista de compras
                            </div>
                        )}

                        {books.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                                <span className="text-5xl block mb-3">üìö</span>
                                <p>Esta biblioteca est√° vac√≠a</p>
                            </div>
                        ) : (
                            <>
                                {readBooks.length > 0 && (
                                    <div className="mb-6">
                                        <h2 className="font-semibold text-green-700 mb-3 flex items-center gap-2">
                                            <span>‚úì</span> Le√≠dos ({readBooks.length})
                                        </h2>
                                        <div className="space-y-2">
                                            {readBooks.map(book => <BookCard key={book.id} book={book} />)}
                                        </div>
                                    </div>
                                )}

                                {unreadBooks.length > 0 && (
                                    <div>
                                        <h2 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                            <span>üìñ</span> Por leer ({unreadBooks.length})
                                        </h2>
                                        <div className="space-y-2">
                                            {unreadBooks.map(book => <BookCard key={book.id} book={book} />)}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        <div className="mt-8 text-center">
                            {user ? (
                                <a href="/" className="text-gray-700 text-sm hover:underline">
                                    ‚Üê Volver a bibliotecask
                                </a>
                            ) : (
                                <a href="/" className="text-gray-700 text-sm hover:underline">
                                    ¬øQuer√©s crear tu propia biblioteca? ‚Üí
                                </a>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // ============ APP ROOT ============
        function App() {
            const { user, loading } = useAuth();

            // Verificar si hay un par√°metro ?ver=userId en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const viewUserId = urlParams.get('ver');

            // Si hay un userId para ver, mostrar la vista p√∫blica
            if (viewUserId) {
                return <PublicLibraryView userId={viewUserId} />;
            }

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-bg">
                        <div className="text-center text-white">
                            <span className="text-6xl block mb-4">üìö</span>
                            <div className="w-8 h-8 border-3 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                        </div>
                    </div>
                );
            }

            return user ? <MainApp /> : <AuthScreen />;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>
</html>
